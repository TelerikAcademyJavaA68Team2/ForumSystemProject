<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:insert="~{fragments/PageLayout :: head('Post')}"></head>
<header th:insert="~{fragments/PageLayout :: header}"></header>
<body>
<!-- Page content-->
<div class="container mt-5">
    <div class="row">
        <div class="col-lg-8">
            <!-- Post content-->
            <article>
                <!-- Post header-->
                <header class="mb-4">
                    <!-- Post title-->
                    <h1 class="fw-bolder mb-1" th:text="${post.title}">Post Title</h1>
                    <!-- Post meta content-->
                    <div class="d-flex align-items-center">
                        <img th:src="${post.profilePicture}" alt="Profile Picture"
                             class="rounded-circle me-2" style="width: 50px; height: 50px;">
                        <p class="m-0">
                            <span th:text="#{post.label}"></span>
                            <a href="#" sec:authorize="hasAnyAuthority('ADMIN')" th:href="@{/mvc/admin/users{id}(id=${post.getAuthorId()})}"
                               th:text="${post.author}" class="fw-bold text-primary">Author Name</a>
                            <a sec:authorize="!hasAnyAuthority('ADMIN')"
                               th:text="${post.author}">Author Name</a>
                        </p>
                    </div>
                </header>

                <!-- Post content-->
                <section class="mb-5">
                    <p class="fs-5 mb-4" th:text="${post.content}">Post Content</p>
                </section>

                <!-- Tags -->
                <div class="mb-3" th:if="${not #lists.isEmpty(post.tags)}">
                    <span class="fw-bold">Tags:</span>
                    <span th:each="tagName : ${post.tags}">
                        <a class="badge bg-primary text-white text-decoration-none me-1"
                           th:text="${tagName}"
                           th:href="@{/mvc/posts?tag={tagText}(tagText=${tagName})}">Tag</a>
                    </span>
                </div>

                <!-- Like / Dislike buttons -->
                <div class="d-flex align-items-center">
                    <!-- Like Button (only for authenticated users) -->
                    <form th:action="@{/mvc/posts/{id}/like(id=${post.post_id})}" method="post" sec:authorize="isAuthenticated()">
                        <button type="submit"
                                th:class="${hasLiked} ? 'btn btn-success me-2' : 'btn btn-outline-success me-2'">
                            üëç Like <span th:text="${post.likes}">0</span>
                        </button>
                    </form>

                    <!-- Disabled Like Button (for unauthenticated users) -->
                    <button type="button" class="btn btn-outline-success me-2" sec:authorize="!isAuthenticated()" disabled>
                        üëç Like <span th:text="${post.likes}">0</span>
                    </button>

                    <!-- Dislike Button (only for authenticated users) -->
                    <form th:action="@{/mvc/posts/{id}/dislike(id=${post.post_id})}" method="post" sec:authorize="isAuthenticated()">
                        <button type="submit"
                                th:class="${hasDisliked} ? 'btn btn-danger' : 'btn btn-outline-danger'">
                            üëé Dislike <span th:text="${post.dislikes}">0</span>
                        </button>
                    </form>

                    <!-- Disabled Dislike Button (for unauthenticated users) -->
                    <button type="button" class="btn btn-outline-danger" sec:authorize="!isAuthenticated()" disabled>
                        üëé Dislike <span th:text="${post.dislikes}">0</span>
                    </button>
                </div>

                <!-- Show edit/delete buttons only for author or admin -->
                <div class="mt-3" sec:authorize="isAuthenticated()">
                    <div th:if="${currentUser != null and (currentUser.username == post.author or currentUser.isAdmin())}">
                        <a th:href="@{/mvc/posts/{id}/edit(id=${post.post_id})}" class="btn btn-warning">‚úèÔ∏è Edit</a>

                        <form th:action="@{/mvc/posts/{id}/delete(id=${post.post_id})}" method="post" class="d-inline">
                            <button type="submit" class="btn btn-danger">üóëÔ∏è Delete</button>
                        </form>
                    </div>
                </div>
            </article>

            <!-- Comments section -->
            <section class="mb-5">
                <h2 class="fw-bolder mb-4">Comments</h2>
                <div class="card bg-light">
                    <form sec:authorize="isAuthenticated()"
                          th:action="@{/mvc/posts/{id}/comments/new(id=${post.post_id})}" method="post">
                    <textarea class="form-control mb-3" name="content" rows="3"
                              placeholder="Write a comment..." required></textarea>
                        <button class="btn btn-primary" type="submit">üí¨ Add Comment</button>
                    </form>
                    <div class="card-body">
                        <!-- Only show if comments exist -->
                        <div th:if="${not #lists.isEmpty(post.comments)}">
                            <div th:each="comment : ${post.comments}" class="d-flex mt-4">
                                <!-- Divider -->
                                <hr class="full-width-divider"/>
                                <div class="flex-shrink-0">
                                    <img class="rounded-circle"
                                         src="https://dummyimage.com/50x50/ced4da/6c757d.jpg"
                                         alt="Profile Picture"/>
                                </div>
                                <div class="ms-3">
                                    <div class="fw-bold" th:text="${comment.author}">Commenter Name</div>
                                    <p th:text="${comment.content}">Comment content here...</p>

                                </div>
                            </div>
                        </div>

                        <!-- Show message if no comments exist -->
                        <div th:if="${#lists.isEmpty(post.comments)}" class="text-muted">
                            <p>There are no comments for this post.</p>
                        </div>

                        <!-- Comment form (only for authenticated users) -->
                        <div sec:authorize="isAuthenticated()">
                            <!-- Error Message for Comments -->
                            <div th:if="${commentError}" class="alert alert-danger">
                                <span th:text="${commentError}"></span>
                            </div>

                            <!-- Success Message for Comments -->
                            <div th:if="${commentSuccess}" class="alert alert-success">
                                <span th:text="${commentSuccess}"></span>
                            </div>

                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Sidebar Widgets -->
        <div class="col-lg-4">
            <!-- Search widget-->
            <div class="card mb-4">
                <div class="card-header">Search</div>
                <div class="card-body">
                    <form th:action="@{/mvc/posts}" method="get">
                        <input class="form-control mb-2" type="text" name="title" placeholder="Search by title..."/>
                        <input class="form-control mb-2" type="text" name="author" placeholder="Search by author..."/>
                        <button class="btn btn-primary w-100" type="submit">Search</button>
                    </form>
                </div>
            </div>

            <!-- Tags widget -->
            <div class="card mb-4">
                <div class="card-header">Tags</div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-sm-6">
                            <ul class="list-unstyled mb-0">
                                <li th:each="tag, iterStat : ${tags}" th:if="${iterStat.index % 2 == 0}">
                                    <a href="#" th:href="@{/mvc/posts?tag={tagText}(tagText=${tag.tagName})}"
                                       th:text="${tag.tagName}">Tag</a>
                                </li>
                            </ul>
                        </div>
                        <div class="col-sm-6">
                            <ul class="list-unstyled mb-0">
                                <li th:each="tag, iterStat : ${tags}" th:if="${iterStat.index % 2 == 1}">
                                    <a href="#" th:href="@{/mvc/posts?tag={tagText}(tagText=${tag.tagName})}"
                                       th:text="${tag.tagName}">Tag</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
<footer th:insert="~{fragments/PageLayout :: footer}"></footer>
</body>
</html>
